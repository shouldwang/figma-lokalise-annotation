<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Lokalization List</title>
  <!-- Add JSZip library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', 'Helvetica Neue', Arial, 'Liberation Sans', 'Nimbus Sans', 'sans-serif';
      margin: 0;
      background: #fff;
      min-height: 100vh;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    body::-webkit-scrollbar {
      display: none;
    }
    .sticky-bar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .info-bar {
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .chip-group {
      display: flex;
      gap: 8px;
      padding: 12px;
      flex-wrap: nowrap;             
      overflow-x: auto;              
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      cursor: grab;
    }
    .chip-group::-webkit-scrollbar {
      display:none;
    }
    .chip-group.active {
      cursor: grabbing;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      height: 30px;
      padding: 0px 12px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 400;
      border: 1px solid #e6e6e6;
      background: #fff;
      color: #333;
      cursor: pointer;
      transition: border 0.15s, color 0.15s;
      -webkit-user-select: none;
      user-select: none;
      white-space: nowrap;        
    }
    .chip.selected {
      color: #fff;
      background: #333;
      z-index: 1;
    }
    .dup-warning-list {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      font-size: 14px;
      font-weight: 600;
      color: #e00;
      background: #ee000011;
    }
    .card-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1 1 auto;
      min-height: 0;
      padding: 12px 12px 80px 12px;
      background: #fafafa;
    }
    .card {
      background: #fff;
      border: 1px solid #E6E6E6;
      border-radius: 4px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: border-color 0.15s, box-shadow 0.15s;
      position: relative;
    }
    .card:hover {
      border-color: #CCCCCC;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .card.disabled {
      pointer-events: none;
      opacity: 0.3;
    }
    .card-duplicate {
      box-shadow: 0 0 0 2px #ff333355;
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .project-label {
      background: #1d4ed812;
      border-radius: 1px;
      font-family: 'DM Mono', 'Menlo', 'Consolas', monospace;
      font-size: 12px;
      font-weight: 500;
      color: #333333;
      padding: 6px;
      display: inline-block;
      line-height: 1;
    }
    .card-actions {
      display: flex;
      gap: 8px;
    }
    .card-action-btn {
      border: 1px solid #E6E6E6;
      background: #fff;
      border-radius: 2px;
      height: 28px;
      width: 28px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
      outline: none;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card-action-btn:hover {
      background: #FAFAFA;
    }
    .card-action-btn[disabled] {
      color: #b3b3b3;
      border-color: #eee;
      cursor: not-allowed;
      background: #fafafa;
    }
    .card-action-btn .tooltip {
      display: none;
      position: absolute;
      bottom: 120%;
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      color: #fff;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 4px;
      white-space: nowrap;
      z-index: 10;
      pointer-events: none;
    }
    .card-action-btn:hover .tooltip {
      display: block;
    }
    .card-key {
      font-size: 15px;
      font-weight: 600;
      color: #333333;
      line-height: 1.5;
      word-break: break-all;
    }
    .card-draft {
      font-size: 15px;
      font-weight: 400;
      color: #333;
      line-height: 1.5;
      word-break: break-word;
    }
    .card-edit-row {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .card-edit-header {
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
    }
    .edit-row-top {
      display: flex;
      flex-direction: row;
      gap: 8px;
      align-items: stretch;
    }
    .select-inline {
      width: 100%;
      min-width: 80px;
      font-size: 14px;
      flex: 1 1 auto;
      height: 32px;
      border: 1px solid #e6e6e6;
      border-radius: 4px;
      padding-right: 24px;
    }
    .save-btn {
      flex: 0 0 auto;
      height: 100%;
      padding: 4px 16px;
      font-size: 14px;
      border-radius: 2px;
      border: 1px solid #1d4ed8;
      background: #1d4ed8;
      color: #fff;
      font-weight: 600;
      transition: background 0.15s, border-color 0.15s;
    }
    .save-btn:disabled {
      background: #e5e7eb;
      color: #b3b3b3;
      border: 1px solid #e5e7eb;
      cursor: not-allowed;
    }
    .input-inline {
      width: 100%;
      font-size: 14px;
      height: 32px;
      box-sizing: border-box;
      border-radius:4px;
      border: 1px solid #e6e6e6;
      padding: 0 8px;
    }
    .error-msg {
      color: #ff3333;
      font-size: 14px;
    }
    .disabled-text {
      color: #b3b3b3 !important;
    }
    /* Floating Action Button Styles */
    .fab-container {
      width: calc(100% - 16px);
      position: fixed;
      bottom: 16px;
      left: 8px;
      display: flex;
      flex-direction: row;
      align-items: stretch;
      justify-content: space-between;
      gap: 16px;
      z-index: 1000;
    }
    
    .fab-search-container {
      width: 100%;
      display: flex;
      align-items: center;
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 999px;
      padding: 8px 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      transition: box-shadow 0.15s, border-color 0.15s;
    }
    
    .fab-search-container:focus-within {
      border: 2px solid #1d4ed8;
      box-shadow: 0 4px 20px rgba(29, 78, 216, 0.15);
    }
    
    .fab-search-input {
      border: none;
      outline: none;
      font-size: 14px;
      width: 100%;
      padding: 4px 0;
      background: transparent;
    }
    
    .fab-search-input::placeholder {
      color: #999;
    }
    
    .fab-export-btn {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      font-size: 20px;
      background: #396af2;
      color: #fff;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(29, 78, 216, 0.3);
      transition: all 0.15s;
    }
     .fab-export-btn .tooltip {
      display: none;
      position: absolute;
      bottom: 52px;
      right: 0px;
      background: #222;
      color: #fff;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 4px;
      white-space: nowrap;
      z-index: 10;
      pointer-events: none;
    }
    .fab-export-btn:hover .tooltip {
      display: block;
    }
    
    .fab-export-btn:hover:not(:disabled) {
      background: #1e40af;
      box-shadow: 0 8px 24px rgba(29, 78, 216, 0.4);
    }
    
    .fab-export-btn:disabled {
      background: #e5e7eb;
      color: #9ca3af;
      cursor: not-allowed;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: none;
    }
    
    .dropdown-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.3);
      z-index: 998;
      display: none;
    }
    
    .dropdown-menu {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 382px;
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 8px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      z-index: 999;
      display: none;
      padding: 8px 0;
      transform-origin: bottom right;
    }
    
    .dropdown-item {
      padding: 16px;
      cursor: pointer;
      font-size: 14px;
      color: #333;
      background: #fff;
      transition: background 0.15s;
      border: none;
      outline: none;
    }
    
    .dropdown-item:hover:not(.disabled) {
      background: #f5f7fa;
    }
    
    .dropdown-item.disabled {
      color: #bbb;
      cursor: not-allowed;
      background: #fff;
    }
  </style>
</head>
<body>
  <div class="sticky-bar">
    <div class="info-bar">
      <div class="chip-group" id="projectChipGroup"></div>
      <div id="dupWarningsContainer"></div>
    </div>
  </div>
  <div class="card-list" id="cardList"></div>
  
  <!-- Floating Action Buttons -->
  <div class="fab-container">
    <div class="fab-search-container">
      <input id="searchKey" class="fab-search-input" type="text" placeholder="Search Key">
    </div>
    <div style="position:relative;display:inline-block;">
      <button id="exportBtn" class="fab-export-btn" disabled>üíæ<span class="tooltip">Export CSV</span></button>
      <div id="exportDropdown" class="dropdown-menu"></div>
    </div>
  </div>
  
  <!-- Backdrop for dropdown -->
  <div id="dropdownBackdrop" class="dropdown-backdrop"></div>
  
  <script>
let currentData = [];
let editingIndex = null;
let filterProject = "All";
let searchKey = "";
let showDupKeys = [];
let projectList = [];

function getProjectList() { return projectList; }

// --- chip group ÊãñÊãΩÂäüËÉΩ ---
function initChipGroupDrag() {
  const chipGroup = document.getElementById('projectChipGroup');
  let isDown = false;
  let startX;
  let scrollLeft;

  chipGroup.addEventListener('mousedown', (e) => {
    isDown = true;
    chipGroup.classList.add('active');
    startX = e.pageX - chipGroup.offsetLeft;
    scrollLeft = chipGroup.scrollLeft;
    chipGroup.style.cursor = 'grabbing';
    chipGroup.style.userSelect = 'none';
  });

  chipGroup.addEventListener('mouseleave', () => {
    isDown = false;
    chipGroup.classList.remove('active');
    chipGroup.style.cursor = 'grab';
    chipGroup.style.userSelect = 'auto';
  });

  chipGroup.addEventListener('mouseup', () => {
    isDown = false;
    chipGroup.classList.remove('active');
    chipGroup.style.cursor = 'grab';
    chipGroup.style.userSelect = 'auto';
  });

  chipGroup.addEventListener('mousemove', (e) => {
    if (!isDown) return;
    e.preventDefault();
    const x = e.pageX - chipGroup.offsetLeft;
    const walk = (x - startX) * 2; // Ë™øÊï¥ÊãñÊãΩÈÄüÂ∫¶
    chipGroup.scrollLeft = scrollLeft - walk;
  });

  // Ë®≠ÁΩÆÂàùÂßãÊ®£Âºè
  chipGroup.style.cursor = 'grab';
}

// --- Êñ∞Â¢û chip group Ê∏≤Êüì ---
function renderProjectChipGroup() {
  const chipGroup = document.getElementById('projectChipGroup');
  chipGroup.innerHTML = '';
  // Ë®àÁÆóÂêÑ project Á≠ÜÊï∏
  const projects = getProjectList();
  const countMap = {};
  projects.forEach(proj => countMap[proj] = 0);
  mergeIdenticalEntries(currentData).forEach(row => {
    if (countMap.hasOwnProperty(row.projectName)) countMap[row.projectName]++;
  });
  // All Á≠ÜÊï∏
  const allCount = mergeIdenticalEntries(currentData).length;
  // Áî¢Áîü All chip
  const allChip = document.createElement('div');
  allChip.className = 'chip' + (filterProject === "All" ? ' selected' : '');
  allChip.textContent = `All (${allCount})`;
  allChip.onclick = () => {
    filterProject = "All";
    editingIndex = null;
    showDupKeys = [];
    renderProjectChipGroup();
    renderCardList(getFilteredData(), null);
    updateExportDropdownState();
  };
  chipGroup.appendChild(allChip);
  // Áî¢ÁîüÊúâË≥áÊñôÁöÑ project chipÔºà‰æù projectList È†ÜÂ∫èÔºâ
  projects.forEach(proj => {
    if (countMap[proj] > 0) {
      const chip = document.createElement('div');
      chip.className = 'chip' + (filterProject === proj ? ' selected' : '');
      chip.textContent = `${proj} (${countMap[proj]})`;
      chip.onclick = () => {
        filterProject = proj;
        editingIndex = null;
        showDupKeys = [];
        renderProjectChipGroup();
        renderCardList(getFilteredData(), null);
        updateExportDropdownState();
      };
      chipGroup.appendChild(chip);
    }
  });
}

function findDuplicateKeyNamesDetail(data) {
  const groups = {};
  data.forEach(row => {
    const key = (row.projectName || "") + "||" + (row.keyName || "");
    if (!groups[key]) groups[key] = [];
    groups[key].push(row);
  });
  
  return Object.entries(groups)
    .filter(([k, rows]) => rows.length > 1)
    .map(([k, rows]) => {
      const [project, keyName] = k.split("||");
      const uniqueContents = [...new Set(rows.map(r => r.content || ""))];
      return [project, keyName, rows.length, uniqueContents.length > 1];
    })
    .filter(([project, keyName, count, hasConflict]) => hasConflict); // Only return conflicts
}

function mergeIdenticalEntries(data) {
  const groups = {};
  const merged = [];
  
  data.forEach(row => {
    const key = (row.projectName || "") + "||" + (row.keyName || "") + "||" + (row.content || "");
    if (!groups[key]) {
      groups[key] = row;
      merged.push(row);
    }
    // Identical entries are automatically skipped
  });
  
  return merged;
}

function getFilteredData() {
  let filtered = mergeIdenticalEntries(currentData).filter(row => {
    const projectMatch = (filterProject === "All" || row.projectName === filterProject);
    const searchMatch = (!searchKey || (row.keyName && row.keyName.toLowerCase().includes(searchKey.toLowerCase())));
    return projectMatch && searchMatch;
  });
  if (showDupKeys.length > 0) {
    const dupSet = new Set(showDupKeys);
    filtered = filtered.filter(row => dupSet.has((row.projectName || "") + "||" + (row.keyName || "")));
  }
  return filtered;
}

function renderCardList(data, editingIdx = null) {
  updateExportBtnAndDupWarning(mergeIdenticalEntries(currentData));
  const cardList = document.getElementById("cardList");
  cardList.innerHTML = "";
  if (Array.isArray(data) && data.length > 0) {
    const dupSet = new Set(findDuplicateKeyNamesDetail(mergeIdenticalEntries(currentData)).map(([project, keyName]) => project + "||" + keyName));
    data.forEach((row, idx) => {
      const card = document.createElement("div");
      card.className = "card" +
        (dupSet.has(row.projectName + "||" + row.keyName) ? " card-duplicate" : "") +
        (editingIdx === idx ? "" : "");
      if (editingIdx !== null && editingIdx !== idx) {
        card.classList.add("disabled");
      }
      card.dataset.index = idx;

      // È†êË®≠Ê®°Âºè
      if (editingIdx !== idx) {
        card.innerHTML = `
          <div class="card-header">
            <span class="project-label">${row.projectName || ""}</span>
            <div class="card-actions">
              <button class="card-action-btn locate-btn" title="Locate">
                üìç<span class="tooltip">Locate</span>
              </button>
              <button class="card-action-btn edit-btn" title="Edit">
                ‚úèÔ∏è<span class="tooltip">Edit</span>
              </button>
              <button class="card-action-btn delete-btn" title="Delete">
                üóëÔ∏è<span class="tooltip">Delete</span>
              </button>
            </div>
          </div>
          <div class="card-key">${row.keyName || ""}</div>
          <div class="card-draft">${row.content || ""}</div>
        `;
        // Á∂ÅÂÆö action btns
        card.querySelector('.locate-btn').onclick = (e) => {
          e.stopPropagation();
          parent.postMessage({
            pluginMessage: { type: "locate-row", uuid: row.uuid }
          }, "*");
        };
        card.querySelector('.edit-btn').onclick = (e) => {
          e.stopPropagation();
          editingIndex = idx;
          renderCardList(getFilteredData(), editingIndex);
        };
        card.querySelector('.delete-btn').onclick = (e) => {
          e.stopPropagation();
          if (confirm('Are you sure you want to delete this row?')) {
            parent.postMessage({
              pluginMessage: { type: "delete-row", uuid: row.uuid }
            }, "*");
          }
        };
      } else {
        // Á∑®ËºØÊ®°Âºè
        const projects = getProjectList();
        card.innerHTML = `
          <div class="card-edit-row">
            <div class="card-edit-header">
              <div class="edit-row-top">
                <select class="select-inline" id="edit-project">
                  ${projects.map(p => `<option value="${p}"${row.projectName === p ? " selected" : ""}>${p}</option>`).join("")}
                </select>
                <button class="save-btn" id="save-btn">Save</button>
              </div>
              <input class="input-inline" id="edit-key" value="${row.keyName || ""}" autocomplete="off">
              <div class="error-msg" id="edit-key-err" style="display:none"></div>
            </div>
            <div class="card-draft">${row.content || ""}</div>
          </div>
        `;
        // Á∂ÅÂÆöÂÑ≤Â≠ò
        const saveBtn = card.querySelector('#save-btn');
        const keyInput = card.querySelector('#edit-key');
        const projectSelect = card.querySelector('#edit-project');
        const keyErr = card.querySelector('#edit-key-err');
        function validateEdit() {
          let valid = true;
          let keyVal = keyInput.value.replace(/[^A-Za-z0-9\-\_\.]/g, '');
          keyInput.value = keyVal;
          if (!keyVal) {
            keyErr.textContent = "Key cannot be empty";
            keyErr.style.display = "block";
            valid = false;
          } else if (!/^[A-Za-z0-9\-\_\.]+$/.test(keyVal)) {
            keyErr.textContent = "Only uppercase and lowercase letters, numbers, -, _, . are allowed.";
            keyErr.style.display = "block";
            valid = false;
          } else {
            keyErr.style.display = "none";
          }
          saveBtn.disabled = !valid;
          return valid;
        }
        keyInput.addEventListener('input', validateEdit);
        saveBtn.onclick = function() {
          if (!validateEdit()) return;
          const newProject = projectSelect.value;
          const newKey = keyInput.value;
          parent.postMessage({
            pluginMessage: {
              type: "update-row",
              uuid: row.uuid,
              projectName: newProject,
              keyName: newKey
            }
          }, "*");
        };
        validateEdit();
      }
      cardList.appendChild(card);
    });
  } else {
    const emptyDiv = document.createElement("div");
    emptyDiv.style.color = "#888";
    emptyDiv.style.textAlign = "center";
    emptyDiv.style.margin = "32px 0";
    emptyDiv.textContent = "No data found.";
    cardList.appendChild(emptyDiv);
  }
}

function updateExportBtnAndDupWarning(data) {
  const exportBtn = document.getElementById("exportBtn");
  const dupWarningsContainer = document.getElementById("dupWarningsContainer");

  // Ë©≥ÂàóÊâÄÊúâÈáçË§á keyÔºà‰ª• project+keyName ÁÇ∫ÂñÆ‰ΩçÔºå‰ΩÜÂè™È°ØÁ§∫ content Ë°ùÁ™ÅÁöÑÔºâ
  const dupList = findDuplicateKeyNamesDetail(data);
  dupWarningsContainer.innerHTML = "";
  if (dupList.length > 0) {
    exportBtn.disabled = true;
    dupList.forEach(([project, key, count, hasConflict]) => {
      const keyId = project + "||" + key;
      const warnDiv = document.createElement("div");
      warnDiv.className = "dup-warning-list";
      warnDiv.innerHTML = `<span>You have conflicting content for ${key} in ${project}.</span><button class="action-btn dupCheck-btn" data-key="${keyId}" style="font-size:14px; padding:4px 8px; border-radius:4px; border:none; background:#ffffff; color:#333; cursor:pointer; white-space:nowrap; min-width:fit-content;">${showDupKeys.length === 1 && showDupKeys[0] === keyId ? "show all" : "check"}</button>`;
      dupWarningsContainer.appendChild(warnDiv);
    });
    dupWarningsContainer.querySelectorAll('.dupCheck-btn').forEach(btn => {
      btn.onclick = function() {
        const keyId = this.getAttribute('data-key');
        if (showDupKeys.length === 1 && showDupKeys[0] === keyId) {
          showDupKeys = [];
        } else {
          showDupKeys = [keyId];
        }
        renderCardList(getFilteredData(), null);
      };
    });
  } else {
    exportBtn.disabled = !(Array.isArray(currentData) && currentData.length > 0);
  }
}

function updateExportDropdownState() {
  const projects = getProjectList();
  const countMap = {};
  projects.forEach(proj => countMap[proj] = 0);
  mergeIdenticalEntries(currentData).forEach(row => {
    if (countMap.hasOwnProperty(row.projectName)) {
      countMap[row.projectName]++;
    }
  });
  // Download Bundle
  const totalProjects = projects.filter(proj => countMap[proj] > 0).length;
  document.querySelector('.export-count[data-count-for="download-bundle"]').textContent = `(${totalProjects} projects)`;
  projects.forEach(proj => {
    const item = document.querySelector(`.dropdown-item[data-action="${proj}"]`);
    const countSpan = document.querySelector(`.export-count[data-count-for="${proj}"]`);
    if (countSpan) countSpan.textContent = `(${countMap[proj]})`;
    if (item) {
      if (countMap[proj] === 0) {
        item.classList.add("disabled");
        item.setAttribute("tabindex", "-1");
      } else {
        item.classList.remove("disabled");
        item.setAttribute("tabindex", "0");
      }
    }
  });
  // Ëã•ÂÆåÂÖ®ÁÑ°Ë≥áÊñôÔºåexportBtn ‰πü disabled
  const exportBtn = document.getElementById("exportBtn");
  if (currentData.length === 0) {
    exportBtn.disabled = true;
  }
}

// ÂåØÂá∫ CSV
function escapeCSV(value) {
  if (value == null) return '';
  const str = String(value);
  if (str.includes(',') || str.includes('"') || str.includes('\n') || str.includes('\r')) {
    return '"' + str.replace(/"/g, '""') + '"';
  }
  return str;
}

function exportCSVNoHeader(rows, filename) {
  const csv = rows.join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }, 0);
}

function handleExportAction(action) {
  let rows = [];
  let filename = "";
  const today = (new Date()).toISOString().slice(0,10).replace(/-/g, '');
  if (action === "download-bundle") {
    // Download all projects as separate CSV files in a ZIP
    downloadProjectBundle(today);
    return;
  } else {
    const proj = action;
    let projRows = mergeIdenticalEntries(currentData).filter(row => row.projectName === proj);
    // Add header for individual project export
    const header = ["Key", "en", "ja", "en-US", "zh-TW", "zh-CN"].map(escapeCSV).join(",");
    rows = [header, ...projRows.map(row =>
      [row.keyName, row.content, "", "", "", ""].map(escapeCSV).join(",")
    )];
    filename = `proj-${proj}-${today}.csv`;
  }
  exportCSVNoHeader(rows, filename);
}

// New function to download all projects as a bundle
async function downloadProjectBundle(today) {
  const projects = getProjectList();
  const mergedData = mergeIdenticalEntries(currentData);
  const projectsWithData = projects.filter(proj => 
    mergedData.some(row => row.projectName === proj)
  );
  
  if (projectsWithData.length === 0) return;
  
  const zip = new JSZip();
  
  // Add each project as a CSV file to the ZIP
  projectsWithData.forEach(proj => {
    const projRows = mergedData.filter(row => row.projectName === proj);
    const header = ["Key", "en", "ja", "en-US", "zh-TW", "zh-CN"].map(escapeCSV).join(",");
    const csvContent = [header, ...projRows.map(row =>
      [row.keyName, row.content, "", "", "", ""].map(escapeCSV).join(",")
    )].join("\n");
    
    zip.file(`proj-${proj}-${today}.csv`, csvContent);
  });
  
  // Generate and download the ZIP file
  try {
    const content = await zip.generateAsync({type: "blob"});
    const url = URL.createObjectURL(content);
    const a = document.createElement("a");
    a.href = url;
    a.download = `lokalise-projects-bundle-${today}.zip`;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 0);
  } catch (error) {
    console.error("Error creating ZIP file:", error);
    // Fallback to individual downloads with user confirmation
    if (confirm(`Failed to create ZIP bundle. Download ${projectsWithData.length} files individually instead?`)) {
      projectsWithData.forEach((proj, index) => {
        setTimeout(() => {
          const projRows = currentData.filter(row => row.projectName === proj);
          const header = ["Key", "en", "ja", "en-US", "zh-TW", "zh-CN"].map(escapeCSV).join(",");
          const rows = [header, ...projRows.map(row =>
            [row.keyName, row.content, "", "", "", ""].map(escapeCSV).join(",")
          )];
          const filename = `proj-${proj}-${today}.csv`;
          exportCSVNoHeader(rows, filename);
        }, index * 1000); // 1 second delay between downloads
      });
    }
  }
}

// ÊêúÂ∞ã key
document.getElementById('searchKey').addEventListener('input', function(e) {
  searchKey = this.value;
  editingIndex = null;
  showDupKeys = [];
  renderCardList(getFilteredData(), null);
});

// Export dropdown
const exportBtn = document.getElementById("exportBtn");
const exportDropdown = document.getElementById("exportDropdown");
const dropdownBackdrop = document.getElementById("dropdownBackdrop");

exportBtn.onclick = function(e) {
  if (exportBtn.disabled) return;
  const isOpen = exportDropdown.style.display === "block";
  if (isOpen) {
    exportDropdown.style.display = "none";
    dropdownBackdrop.style.display = "none";
  } else {
    exportDropdown.style.display = "block";
    dropdownBackdrop.style.display = "block";
  }
  e.stopPropagation();
};

dropdownBackdrop.onclick = function() {
  exportDropdown.style.display = "none";
  dropdownBackdrop.style.display = "none";
};

document.addEventListener('click', function(e) {
  exportDropdown.style.display = "none";
  dropdownBackdrop.style.display = "none";
});

function bindExportDropdownEvents() {
  exportDropdown.querySelectorAll('.dropdown-item').forEach(opt => {
    opt.onclick = function() {
      if (opt.classList.contains("disabled")) return;
      const action = this.getAttribute('data-action');
      handleExportAction(action);
      exportDropdown.style.display = "none";
      dropdownBackdrop.style.display = "none";
    };
  });
}

function renderExportDropdown() {
  const exportDropdown = document.getElementById("exportDropdown");
  const projects = getProjectList();
  const projectsWithData = projects.filter(proj => 
    currentData.some(row => row.projectName === proj)
  );
  
  let html = `
    <div class="dropdown-item" data-action="download-bundle" tabindex="0">
      Download Bundle <span class="export-count" data-count-for="download-bundle">(${projectsWithData.length} projects)</span>
    </div>
  `;
  projects.forEach(proj => {
    const count = currentData.filter(row => row.projectName === proj).length;
    if (count > 0) {
      html += `
        <div class="dropdown-item" data-action="${proj}" tabindex="0">
          ${proj} <span class="export-count" data-count-for="${proj}">(${count})</span>
        </div>
      `;
    }
  });
  exportDropdown.innerHTML = html;
}

// ËôïÁêÜ Figma ÂÇ≥‰æÜÁöÑË≥áÊñô
window.onmessage = (event) => {
  const { pluginMessage } = event.data;
  if (pluginMessage && pluginMessage.type === "lokalise-data") {
    currentData = pluginMessage.data;
    editingIndex = null;
    showDupKeys = [];
    updateAllUI();
  }
  if (pluginMessage && pluginMessage.type === "lokalise-data-updated") {
    currentData = pluginMessage.data;
    editingIndex = null;
    showDupKeys = [];
    updateAllUI();
  }
  if (pluginMessage && pluginMessage.type === "project-list") {
    projectList = Array.isArray(pluginMessage.projects) ? pluginMessage.projects : [];
    updateAllUI();
  }
};

function updateAllUI() {
  renderProjectChipGroup();
  initChipGroupDrag();
  renderExportDropdown();
  bindExportDropdownEvents();
  renderCardList(getFilteredData(), editingIndex);
  updateExportDropdownState();
}

window.onload = () => {
  renderProjectChipGroup();
  initChipGroupDrag();
  renderExportDropdown();
  bindExportDropdownEvents();
  renderCardList([], null);
  updateExportDropdownState();
  parent.postMessage({ pluginMessage: { type: 'get-lokalise-list' } }, '*');
  parent.postMessage({ pluginMessage: { type: 'get-projects' } }, '*');
};
  </script>
</body>
</html>